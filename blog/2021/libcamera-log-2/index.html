<!DOCTYPE html> <html lang=""> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Making a simple camera streamer with libcamera | Vedant Paranjape </title> <meta name="author" content="Vedant Paranjape"> <meta name="description" content="This is a log for documenting issues/observations encountered while creating an Qt app with libcamera"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?v=a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?v=f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?v=62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?v=591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%94%A5&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?v=d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="/blog/2021/libcamera-log-2/"> <script src="/assets/js/theme.js?v=a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?v=5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Vedant</span> Paranjape </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Making a simple camera streamer with libcamera</h1> <p class="post-meta"> Created on April 04, 2021 </p> <p class="post-tags"> <a href="/blog/2021"> <i class="fa-solid fa-calendar fa-sm"></i> 2021 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><strong>I am applying for GSoC again, but this time with libcamera. I will log issues I faced while compiling and running it</strong></p> <p><a href="https://github.com/VedantParanjape/libcamera-test-app" rel="external nofollow noopener" target="_blank">Here’s the link to the simple camera streamer app made using Qt5 and libcamera</a>. I did this for learning more about libcamera in general, and it pretty much cleared libcamera for me.</p> <h2 id="a-gist-of-what-i-did">A Gist of what I did</h2> <p>I used qcam as a reference. I went through it’s code and figured out how exactly libcamera is interfaced with Qt Widgets to display the stream. The main driver is the QImage widget. It is repeatedly passed a buffer which holds the frames from webcam, so it updates fairly quickly (I got around 80+ fps) and appears as continuous stream of frames.</p> <p align="center"><img class="img-fluid rounded z-depth-1" src="/assets/img/libcamera-2/fps-snap.png"></p> <p>To give a overview of how I implemented this. Initialised libcamera as usual. Create an object of the Camera Manager, then start it. Then it looks for camera’s connected to the system. Get the id of the first one that is found <code class="language-plaintext highlighter-rouge">cm-&gt;cameras()[0]-&gt;id()</code> and then use this id to acquire access to the camera.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Start the camera manager which handles all the camera's in the syste,</span>
<span class="n">libcamera</span><span class="o">::</span><span class="n">CameraManager</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">libcamera</span><span class="o">::</span><span class="n">CameraManager</span><span class="p">();</span>
<span class="n">cm</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>

<span class="c1">// Display all the camera's connected to the system</span>
<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">camera</span> <span class="o">:</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">cameras</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Camera ID: "</span> <span class="o">&lt;&lt;</span> <span class="n">camera</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Extract id of the first camera detected</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">camera_id</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">cameras</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">();</span>
<span class="c1">// Get the camera object connected to the camera</span>
<span class="n">camera</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">camera_id</span><span class="p">);</span>
<span class="c1">// Acquire the camera so no other process can use it</span>
<span class="n">camera</span><span class="o">-&gt;</span><span class="n">acquire</span><span class="p">();</span>
</code></pre></div></div> <p>After this we need to configure the camera, i.e. specify the image to be used, pixel format in which frames will be generated, etc. We assign <code class="language-plaintext highlighter-rouge">StreamRole::Raw</code> to the stream, and then also specify the pixel format which matches the one supported by <code class="language-plaintext highlighter-rouge">QImage</code> widget. After this we need to validate if the said config is correct. Once it is done, we configure the camera to run with the given config <code class="language-plaintext highlighter-rouge">camera-&gt;configure(config.get());</code>.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Config the camera with Raw StreamRole</span>
<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">libcamera</span><span class="o">::</span><span class="n">CameraConfiguration</span><span class="o">&gt;</span> <span class="n">config</span> <span class="o">=</span> <span class="n">camera</span><span class="o">-&gt;</span><span class="n">generateConfiguration</span><span class="p">({</span><span class="n">libcamera</span><span class="o">::</span><span class="n">StreamRole</span><span class="o">::</span><span class="n">Raw</span><span class="p">});</span>

<span class="c1">// Get the StreamConfiguration Object so that we can change it's parameters</span>
<span class="n">libcamera</span><span class="o">::</span><span class="n">StreamConfiguration</span> <span class="o">&amp;</span><span class="n">streamConfig</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// Try to set the pixel format given by libcamera to one that is compatible</span>
<span class="c1">// with QImage widget</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PixelFormat</span><span class="o">&gt;</span> <span class="n">formats</span> <span class="o">=</span> <span class="n">streamConfig</span><span class="p">.</span><span class="n">formats</span><span class="p">().</span><span class="n">pixelformats</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">PixelFormat</span> <span class="o">&amp;</span><span class="n">format</span> <span class="o">:</span> <span class="n">nativeFormats</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">match</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">formats</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">formats</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">PixelFormat</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">return</span> <span class="n">f</span> <span class="o">==</span> <span class="n">format</span><span class="p">;</span>
                                <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="n">formats</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">streamConfig</span><span class="p">.</span><span class="n">pixelFormat</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Validate the current configuration is correct</span>
<span class="n">config</span><span class="o">-&gt;</span><span class="n">validate</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Default viewfinder configuration is: "</span> <span class="o">&lt;&lt;</span> <span class="n">streamConfig</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// Set the config to the camera</span>
<span class="n">camera</span><span class="o">-&gt;</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</code></pre></div></div> <p>As a next step, we need to allocate buffers, then these buffers will be sent to libcamera, which will fill them with frames from camera and return it back to us to be consumed. We allocate buffers for each stream and then we need to iterate over the vector of <code class="language-plaintext highlighter-rouge">FrameBuffer</code>s and also create request to libcamera to get back filled <code class="language-plaintext highlighter-rouge">FrameBuffer</code>s. So we create request, pass <code class="language-plaintext highlighter-rouge">FrameBuffer</code> to the request and store the requests in an vector for now.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Allocator object which is used to allocated framebuffers for eah stream</span>
<span class="n">FrameBufferAllocator</span> <span class="o">*</span><span class="n">allocator</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FrameBufferAllocator</span><span class="p">(</span><span class="n">camera</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="n">StreamConfiguration</span> <span class="o">&amp;</span><span class="n">cfg</span> <span class="o">:</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">stream</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Can't allocate buffers"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Get the actual object which represents a stream</span>
<span class="n">Stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">streamConfig</span><span class="p">.</span><span class="n">stream</span><span class="p">();</span>
<span class="c1">// Get the framebuffers allocated for the stream</span>
<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">FrameBuffer</span><span class="o">&gt;&gt;</span> <span class="o">&amp;</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
<span class="c1">// Create a vector for storing requests which will be queued laterop</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;&gt;</span> <span class="n">requests</span><span class="p">;</span>

<span class="c1">// Iterate over buffers to create requests for each buffer and push the</span>
<span class="c1">// requests into an vector</span>
<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">FrameBuffer</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buffer</span> <span class="o">:</span> <span class="n">buffers</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="n">camera</span><span class="o">-&gt;</span><span class="n">createRequest</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Can't create request"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">addBuffer</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Can't set buffer for request"</span>
                    <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">requests</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now we need to some how let libcamera know what should be done once the request is complete, i.e. the <code class="language-plaintext highlighter-rouge">FrameBuffer</code> is filled up with frames from the camera device. This is done by registering a callback function with libcamera, which will be called when a request is completed. This is very crucial function as it consumes the frames. After this we finally start the camera and iterate over the vector of requests we stored earlier, and pass these requests to the camera object and then wait for it to return.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Register callback function for request completed signal</span>
<span class="n">camera</span><span class="o">-&gt;</span><span class="n">requestCompleted</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">requestComplete</span><span class="p">);</span>

<span class="c1">// Finally start the camera</span>
<span class="n">camera</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
<span class="c1">// Iterate over the generated requests and queue them to libcamera to be fulfilled</span>
<span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">libcamera</span><span class="o">::</span><span class="n">Request</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">request</span> <span class="o">:</span> <span class="n">requests</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">camera</span><span class="o">-&gt;</span><span class="n">queueRequest</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now, a bit about Qt part. I create a QApplication object, this drives the application, also alloc a new QLabel which is used to display the QImage widget.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// QAppplication main window object</span>
<span class="n">QApplication</span> <span class="nf">window</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="c1">// alloc memory for viewfinder_label</span>
<span class="n">viewfinder_label</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QLabel</span><span class="p">;</span>
</code></pre></div></div> <p>Next, comes the callback, it is passed a Request object, which has all the data from the camera, which is <code class="language-plaintext highlighter-rouge">FrameBuffer</code> and <code class="language-plaintext highlighter-rouge">Stream</code>. Here we extract the buffer from the <code class="language-plaintext highlighter-rouge">Request</code> object. Also read into the metadata to get some frame info to be printed for debugging. The <code class="language-plaintext highlighter-rouge">FrameBuffer</code> is a not a simple <code class="language-plaintext highlighter-rouge">uchar</code> array. It also has several other things, so we need the data in <code class="language-plaintext highlighter-rouge">unsigned char</code> array to be useful for QImage. After this we record the current CPU time, and find the time difference between previous call to this function and current call, this is used to calculate the FPS and display it. After this we load image into QImage widget and also display the FPS. Once we are done, we notify that we want to reuse the existing buffers for future requests, and then queue a new request, so that it goes on.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Callback function which processes the request once it has been completed by libcamera</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">requestComplete</span><span class="p">(</span><span class="n">Request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Check if the request has been cancelled</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">()</span> <span class="o">==</span> <span class="n">Request</span><span class="o">::</span><span class="n">RequestCancelled</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Extract the buffers filled with images from Request object passed by libcamera </span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Stream</span> <span class="o">*</span><span class="p">,</span> <span class="n">FrameBuffer</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">();</span>

    <span class="c1">// Iterate over the buffer pairs</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">bufferPair</span> <span class="o">:</span> <span class="n">buffers</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Use framebuffer which has the image data</span>
        <span class="n">FrameBuffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">bufferPair</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>

        <span class="c1">// Use the frame metadata</span>
        <span class="k">const</span> <span class="n">FrameMetadata</span> <span class="o">&amp;</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">metadata</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">" seq: "</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setfill</span><span class="p">(</span><span class="sc">'0'</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">metadata</span><span class="p">.</span><span class="n">sequence</span> <span class="o">&lt;&lt;</span> <span class="s">" bytesused: "</span><span class="p">;</span>

        <span class="c1">// Calculate the amount of storage used for a single frame</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nplane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">FrameMetadata</span><span class="o">::</span><span class="n">Plane</span> <span class="o">&amp;</span><span class="n">plane</span> <span class="o">:</span> <span class="n">metadata</span><span class="p">.</span><span class="n">planes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">plane</span><span class="p">.</span><span class="n">bytesused</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">nplane</span> <span class="o">&lt;</span> <span class="n">metadata</span><span class="p">.</span><span class="n">planes</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"/"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

        <span class="c1">// Find the size of buffer</span>
        <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">metadata</span><span class="p">().</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytesused</span><span class="p">;</span>
        <span class="k">const</span> <span class="n">FrameBuffer</span><span class="o">::</span><span class="n">Plane</span> <span class="o">&amp;</span><span class="n">plane</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">planes</span><span class="p">().</span><span class="n">front</span><span class="p">();</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">memory</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">plane</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">plane</span><span class="p">.</span><span class="n">fd</span><span class="p">.</span><span class="n">fd</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>

        <span class="c1">// Load image from a raw buffer into the QImage widget</span>
        <span class="n">viewfinder</span><span class="p">.</span><span class="n">loadFromData</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">memory</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">);</span>

        <span class="c1">// Record the current time and find the time elapsed between two frames</span>
        <span class="c1">// to calculate the FPS</span>
        <span class="kt">clock_t</span> <span class="n">current_time</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">clock</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fps_string</span> <span class="o">=</span> <span class="s">"FPS: "</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">CLOCKS_PER_SEC</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">prev_time</span><span class="p">));</span>
        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">current_time</span><span class="p">;</span>

        <span class="c1">// Display the FPS</span>
        <span class="n">QPainter</span> <span class="nf">fps_label</span><span class="p">(</span><span class="o">&amp;</span><span class="n">viewfinder</span><span class="p">);</span>
        <span class="n">fps_label</span><span class="p">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">black</span><span class="p">));</span>
        <span class="n">fps_label</span><span class="p">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QFont</span><span class="p">(</span><span class="s">"Times"</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="n">QFont</span><span class="o">::</span><span class="n">Bold</span><span class="p">));</span>
        <span class="n">fps_label</span><span class="p">.</span><span class="n">drawText</span><span class="p">(</span><span class="n">viewfinder</span><span class="p">.</span><span class="n">rect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">::</span><span class="n">AlignBottom</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">::</span><span class="n">AlignLeft</span><span class="p">,</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">fps_string</span><span class="p">));</span>

        <span class="c1">// Set the label and show it</span>
        <span class="n">viewfinder_label</span><span class="o">-&gt;</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">QPixmap</span><span class="o">::</span><span class="n">fromImage</span><span class="p">(</span><span class="n">viewfinder</span><span class="p">));</span>
        <span class="n">viewfinder_label</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Indicate that we want to reuse the same buffers passed earlier</span>
    <span class="n">request</span><span class="o">-&gt;</span><span class="n">reuse</span><span class="p">(</span><span class="n">Request</span><span class="o">::</span><span class="n">ReuseBuffers</span><span class="p">);</span>
    <span class="c1">// Queue a new request for frames to libcamera</span>
    <span class="n">camera</span><span class="o">-&gt;</span><span class="n">queueRequest</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Here, we need to call <code class="language-plaintext highlighter-rouge">window.exec</code> function, it handles all Qt related tasks. This is a blocking function, after we quit the application this function exits. We can handle the stuff to deallocate and shutdown libcamera after this, so that application quits gracefully.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Qt window handler</span>
<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">window</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>

<span class="c1">// deallocate after closing window</span>
<span class="n">camera</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="n">allocator</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
<span class="k">delete</span> <span class="n">allocator</span><span class="p">;</span>
<span class="n">camera</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
<span class="n">camera</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="n">cm</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="k">delete</span> <span class="n">viewfinder_label</span><span class="p">;</span>

<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>So, here is how it worked !! Was lot of fun :) I have attached a screen grab of the application running below.</p> <p align="center"><img class="img-fluid rounded z-depth-1" src="/assets/img/libcamera-2/app-snap.png"></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/" target="_blank" rel="external nofollow noopener">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2" target="_blank" rel="external nofollow noopener">Displaying External Posts on Your al-folio Blog</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/plotly/">a post with plotly.js</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/photo-gallery/">a post with image galleries</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/tabs/">a post with tabs</a> </li> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2026 Vedant Paranjape. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: January 16, 2026. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?v=a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?v=85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?v=2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?v=c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?v=c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?v=d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?v=a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?v=2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script type="module" src="/assets/js/search/ninja-keys.min.js?v=a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?v=6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?v=6f508d74becd347268a7f822bca7309d"></script> </body> </html>