<!DOCTYPE html> <html lang=""> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Midway through Google Summer of Code 21 with libcamera | Vedant Paranjape </title> <meta name="author" content="Vedant Paranjape"> <meta name="description" content="This is a writeup describing my experience uptil now working with libcamera"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?v=a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?v=f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?v=62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?v=591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%94%A5&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?v=d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="/blog/2021/gsoc-libcamera/"> <script src="/assets/js/theme.js?v=a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?v=5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Vedant</span> Paranjape </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Midway through Google Summer of Code 21 with libcamera</h1> <p class="post-meta"> Created on July 19, 2021 </p> <p class="post-tags"> <a href="/blog/2021"> <i class="fa-solid fa-calendar fa-sm"></i> 2021 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I began, as most GSoC-ers do, buried in a mountain of code. Initially working with libcamera was intimidating to be honest. Simply because, it’s much more difficult to understand and contribute to code that is written by someone else. After digging through each and every function and figuring out what its use was, I could finally start to see the bigger picture that was Libcamera and how gstreamer fit in. Docs of gstreamer and glib came in very handy. I had a decent idea of how to use libcamera, my efforts in solving the warm up tasks paid off well.</p> <p>Here’s my progress tracker: <a href="https://ve0x10.in/gsoc2021/" rel="external nofollow noopener" target="_blank">https://ve0x10.in/gsoc2021/</a></p> <h1 id="experience">Experience</h1> <h2 id="student-application-period">Student Application period</h2> <p>Armed with my experience of applying to GSoC organization last year, I applied the same this year, communication being the most important point for being selected. I logged everything I did and was active on libcamera IRC asking doubts and improving my understanding of libcamera. One major obstacle I faced in <strong>Student Application period</strong> was learning how to send a patch over email. The first patch I sent was adding troubleshooting section in the README, after 10-15 versions and long thread of discussion over mailing list, it was finally accepted and merged in. Felt like I had just won a <a href="https://git.linuxtv.org/libcamera.git/commit/?id=76a5861f3ef0950d9b57e54668c9059ed7bddd89" rel="external nofollow noopener" target="_blank">trophy</a>. Special thanks to the libcamera community who walked me through everything like I’m a 5-year-old, i.e, answered all my doubts even though basic. While first trying to compile and test the example apps in libcamera, I faced few issues and I did document them and how I got around them, and this helped me big time while doing my project and also to exhibit my seriousness to my mentors. Here’s the two logs: <a href="https://ve0x10.in/blog/2021/03/23/libcamera-log.html" rel="external nofollow noopener" target="_blank">1</a> and <a href="https://ve0x10.in/blog/2021/04/04/libcamera-log-2.html" rel="external nofollow noopener" target="_blank">2</a>.</p> <h2 id="community-bonding">Community Bonding</h2> <p>Results were out on May 17th, I got a mail at 23:30 of my selection. Although I didn’t feel the naive excitement of being selected for GSoC for the very first time, but it did make me happy to see my efforts rewarded by my mentors and that I’d get to work on a <em>linux kernel</em>-like open source project (I mean in terms of way of contributions). After selection, I got in touch with both of my mentors, Paul and Nicolas. Finding a common time for a weekly meeting was tricky, as we all lived in equally spaced three different timezones, Nicolas in Canada, me in India and Paul in Japan, we did settle on a time and I created a matrix group for discussion with my mentors.</p> <h2 id="coding-period">Coding Period</h2> <p>I couldn’t read much in the community bonding period, as I had other stuff to attend to. Come June and I was finally free, I started working from 1 June itself, i.e. one week before the official start date. I started with going through the gstreamer libcamera element’s source code. Much of the code was like a alien language to me, as I had never worked with gstreamer or glib. glib is a C library which adds C++ like OOPS features to C, and gstreamer uses it extensively. glib is a pretty complex library, I had to give in extra efforts to understand basic things like how a class is defined using glib, it has a very non-intuitve way to do so, I’ll give a short example.</p> <ul> <li>gstlibcamerasrc.h <div class="language-c highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>  <span class="cp">#define GST_TYPE_LIBCAMERA_SRC gst_libcamera_src_get_type()
</span>  <span class="n">G_DECLARE_FINAL_TYPE</span><span class="p">(</span><span class="n">GstLibcameraSrc</span><span class="p">,</span> <span class="n">gst_libcamera_src</span><span class="p">,</span>
              <span class="n">GST_LIBCAMERA</span><span class="p">,</span> <span class="n">SRC</span><span class="p">,</span> <span class="n">GstElement</span><span class="p">)</span>
</code></pre></div> </div> </li> <li>gstlibcamerasrc.cpp <div class="language-c highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>  <span class="k">struct</span> <span class="n">_GstLibcameraSrc</span> <span class="p">{</span>
      <span class="n">GstElement</span> <span class="n">parent</span><span class="p">;</span>

      <span class="n">GRecMutex</span> <span class="n">stream_lock</span><span class="p">;</span>
      <span class="n">GstTask</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

      <span class="n">gchar</span> <span class="o">*</span><span class="n">camera_name</span><span class="p">;</span>

      <span class="n">GstLibcameraSrcState</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
      <span class="n">GstLibcameraAllocator</span> <span class="o">*</span><span class="n">allocator</span><span class="p">;</span>
      <span class="n">GstFlowCombiner</span> <span class="o">*</span><span class="n">flow_combiner</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="n">G_DEFINE_TYPE_WITH_CODE</span><span class="p">(</span><span class="n">GstLibcameraSrc</span><span class="p">,</span> <span class="n">gst_libcamera_src</span><span class="p">,</span> <span class="n">GST_TYPE_ELEMENT</span><span class="p">,</span>
              <span class="n">GST_DEBUG_CATEGORY_INIT</span><span class="p">(</span><span class="n">source_debug</span><span class="p">,</span> <span class="s">"libcamerasrc"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="s">"libcamera Source"</span><span class="p">))</span>
</code></pre></div> </div> </li> </ul> <p>Welcome to the rabbit hole that is glib, yes this is how you define a gclass called <code class="language-plaintext highlighter-rouge">GstLibcameraSrc</code>, to be fair it does provide excellent documentation. Another feature of glib which is equally confusing is <code class="language-plaintext highlighter-rouge">g_pointer</code> and how it handles references. There’s no equivalent of a <code class="language-plaintext highlighter-rouge">unique_ptr</code> and <code class="language-plaintext highlighter-rouge">shared_ptr</code>, there’s just a normal <code class="language-plaintext highlighter-rouge">gpointer</code> (also <code class="language-plaintext highlighter-rouge">g_autoptr</code> and <code class="language-plaintext highlighter-rouge">g_autofree</code>). Now each pointer has a count of references, to put it in layman’s terms number of copies that exist for a pointer, you might confuse this for a <code class="language-plaintext highlighter-rouge">std::shared_ptr</code> but don’t it’s not a <code class="language-plaintext highlighter-rouge">shared_ptr</code> or a <code class="language-plaintext highlighter-rouge">unique_ptr</code>. To achieve a functionality <em>similar</em> to <code class="language-plaintext highlighter-rouge">shared_ptr</code>, there are two functions called <code class="language-plaintext highlighter-rouge">g_object_ref()</code> and <code class="language-plaintext highlighter-rouge">g_object_unref()</code>.</p> <p>Here’s what the docs for <code class="language-plaintext highlighter-rouge">g_object_ref</code> say</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Increases the reference count of object .
</code></pre></div></div> <p>and Here’s what the docs for <code class="language-plaintext highlighter-rouge">g_object_unref</code> say</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Decreases the reference count of object . When its reference count drops to 0, the object is finalized (i.e. its memory is freed).
</code></pre></div></div> <p>So, tldr, with these two functions the pointer behaves like a <code class="language-plaintext highlighter-rouge">shared_ptr</code>, so whenever I’d want to pass a pointer into some other functional block of code, one should take reference of it and pass the reference, and unref it instead of freeing it when done. Coming to the next function, called <code class="language-plaintext highlighter-rouge">g_steal_pointer</code> which does something <em>similar</em> to a <code class="language-plaintext highlighter-rouge">unique_ptr</code>. As the name suggests it steals the ownership of the pointer passed to it and passes it to the caller of the macro.</p> <p>Here’s what the docs for <code class="language-plaintext highlighter-rouge">g_steal_pointer</code> say</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Conceptually, this transfers the ownership of the pointer from the referenced variable to the "caller" of the macro (ie: "steals" the reference).
</code></pre></div></div> <p>To be accurate, <code class="language-plaintext highlighter-rouge">g_steal_pointer</code> is much like <code class="language-plaintext highlighter-rouge">std::move</code>, it will not affect any other hard references but only transfer ownership of the pointer passed to it.</p> <p>Finally, having understood the nitty-gritty of glib, I ventured into gstreamer world, it was relatively easier than glib. Since I had already read docs about creating a custom gstreamer element, this stage was pretty quick. I had come up with a plan to first implement live reconfig on gstreamer, but on discussing this with mentors I was advised not to work on this, I was suggested to work on getting request pads working when gstreamer was not in <code class="language-plaintext highlighter-rouge">PLAYING</code> state. I simply had to implement two callback functions <code class="language-plaintext highlighter-rouge">_request_new_pad</code> and <code class="language-plaintext highlighter-rouge">_release_pad</code> and then pass the function pointer of these to their respective callback handlers in <code class="language-plaintext highlighter-rouge">gst_libcamera_src_class_init</code>. This was a quick step, but the first draft did compile, but it was far from being correct and working. There was an issue with how I was handling mutex. In the <code class="language-plaintext highlighter-rouge">gst_libcamera_src_request_new_pad</code> function, I was taking a lock on <code class="language-plaintext highlighter-rouge">GstLibcameraSrc</code> as follows <code class="language-plaintext highlighter-rouge">GLibLocker lock(GST_OBJECT(self));</code> and then doing the necessary steps. One of the steps was adding the new source pad to <code class="language-plaintext highlighter-rouge">GstElement</code> as follows <code class="language-plaintext highlighter-rouge">gst_element_add_pad(element, pad)</code>. With this code, It ended in a deadlock, and I was not sure why. Again, the reason was the stark difference between <code class="language-plaintext highlighter-rouge">std::mutex</code> and <code class="language-plaintext highlighter-rouge">GMutex</code>. If I lock a <code class="language-plaintext highlighter-rouge">GObject</code> using <code class="language-plaintext highlighter-rouge">GMutex</code> that object is locked even for the scope where the object lock was taken. <code class="language-plaintext highlighter-rouge">std::mutex</code> doesn’t behave this way, and I expected it to. So, in short I was trying to add pad to <code class="language-plaintext highlighter-rouge">element</code> even though it was locked, and thus it ended in a deadlock, with a bit of refactoring the code this problem was eliminated, and boom it started working. Ah, I didn’t get multistream <em>yet</em>, it still failed but not due to deadlock, though a request pad was created and destroyed successfully, thus my callback functions were functional.</p> <p>Next step was writing test code to try multistream functionality. I wrote a example app, but I couldn’t get it working for 2-3 days as I was doing it all wrong. It did create two windows, but only one of them had video from camera other one was blank (app window blurred for privacy)</p> <p align="center"><img class="img-fluid rounded z-depth-1" src="/assets/img/gsoc-log-1/multistream-fail.png"></p> <p>It was something very simple I just had to use gst-launch, I was overengineering it all. Nicolas helped me write the command to make it work, it was as easy as this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gst-launch-1.0 libcamerasrc camera-name="/base/soc/i2c0mux/i2c@1/ov5647@36" name=src src.src ! queue ! videoconvert ! autovideosink src.src_0 ! queue ! videoconvert ! autovideosink
</code></pre></div></div> <p>Since UVC pipeline doesn’t support multistream output, and my laptop has a UVC webcam. I had to shift to a Raspberry Pi 4B+ and use a CSI camera with it, rpi pipeline does support multistream. It took some time to make a working setup, but then it did finally work. I was hardly one week into the internship and I had completed the primary goal of my GSoC project, the amount of code that was needed was surprisingly less, but it did require a considerable amount of understanding and effort to make the changes. It worked, it had a issue, color of one of the stream was incorrect, and I have not able to solve this issue to date. The next step was creating a patch and submitting the patch, it took quite a lot of time to finally get reviewed-by tag. I refactored the code twice to make sure the object is locked for the minimum required time, after a few corrections to the commit message, it was finally merged on 25th June. Here’s the <a href="https://git.linuxtv.org/libcamera.git/commit/?id=53a0d80af0f9983d6bc0d54b0e85403a08721488" rel="external nofollow noopener" target="_blank">commit</a></p> <p align="center"><img class="img-fluid rounded z-depth-1" src="/assets/img/gsoc-log-1/multistream-pass.png"></p> <p>Like I mentioned earlier, the multistream output on raspberry-pi had color disparity. This was the next big task that I needed to fix, upon going through debug logs, I found there was a mismatch between libcamera pixel format and v4l2 pixel format. The next few weeks I worked on fixing this and submitting the patches, they were merged in eventually. But this didn’t fix the color format issue. As of now, I have started working on live reconfig functionality.</p> <h1 id="summary">Summary</h1> <p>Lot of work still needs to be done. Since I finished my primary goal pretty early, Nicolas suggested that it would be good if I make a Qt-GUI app using gstreamer libcamera element which will also showcase multistream capabilities. Other than this, I need to work on live reconfig, such that request pads can be allocated even when gstreamer is in <code class="language-plaintext highlighter-rouge">PLAYING</code> state</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/running-parsec-benchmark/">Bringing up the parsec-3.0 benchmark</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/libcamera-log-2/">Making a simple camera streamer with libcamera</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/libcamera-log/">Getting started with libcamera</a> </li> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2026 Vedant Paranjape. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: January 16, 2026. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?v=a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?v=85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?v=2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?v=c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?v=c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?v=d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?v=a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?v=2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script type="module" src="/assets/js/search/ninja-keys.min.js?v=a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?v=6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?v=6f508d74becd347268a7f822bca7309d"></script> </body> </html>